{{/* Populates layouts/_default/baseof.html */}}

{{ define "main" }}
	{{ if eq "development" hugo.Environment }}
	{{ `<!-- Template: layouts/taxonomy/ncs.terms.html -->` | safeHTML }}
	{{ end }}

	{{ $thisyear := now.Format "2006" }}
	{{ $scratch := newScratch }}
	{{ $timestamp := $.Param "sitedate" | printf "%s %s" "15:04" }}

	{{/* Find the calendar pages with an NCS */}}
	{{ $pages := where .Site.RegularPages "Section" "calendar" }}
 	{{ $pages := $pages | intersect ( where .Site.RegularPages ".Params.ncs" "ne" nil )  }}

	{{/* Collect the call-signs used for NCS sessions. This list is randomly
	     ordered.
	*/}}
	{{ range ( $pages.GroupByDate "2006" ) }}
		{{ if eq .Key $thisyear }}
			{{ range .Pages }}
				{{ $scratch.Add "sessions" .Params.ncs }}
			{{ end }}
		{{ end }}
	{{ end }}

	{{/* Convert the NCS sessions list from a []string to a string
	     so that we can use it with string.Count
	*/}}
	{{ $sessions := delimit ( $scratch.Get "sessions"  ) " " }}

	{{/* Get a list of unique call-signs. This list is unordered. */}}
	{{ $ncs_list :=  $scratch.Get "sessions" | uniq }}

	{{/* Go through the call-sign list and count sessions */}}
	{{ range $ncs_list }}
		{{ $call := . }}

 		{{/* Count the sessions for $call */}}
		{{ $count := strings.Count $call $sessions }}

		{{/* Calculate a weight which is higher for lower counts. */}} 
		{{ $weight := ( sub 1000 $count ) }}

		{{/* Store a key=>value map entry for the call-sign and NCS session count.

		     Leverage the map's (ascending order) auto sorting behavior with keys
		     in the form of "$weight$call" (e.g. "990W1AW" for W1AW w/ 10 sessions).
		     Entries with identical weights auto sort by the call-sign portion of
		     the keys.

		     Store "$count $call" as the value used for output. The value is
		     space delimited for easy splitting.
		*/}}
		{{ $scratch.SetInMap "leaderboard" ( $call | printf "%d%s" $weight ) ( $call | printf "%d %s" $count ) }}
	{{ end }}	

	<header class="entry-header">

		<div class="entry-meta">
			<span class="cat-links">
				<a href="/nets">Nets</a>
			</span>
			{{ $rsspath := "/ncs" }}
			{{ partial "rss" ( dict "rsstitle" "NCS Leader Board" "rsspath" $rsspath ) }}
		</div>
		<h2 class="entry-title">{{ $thisyear }} NCS Leader Board</h2>
	</header>

	<div class="entry-content" style="padding-bottom:1em;">
		<dl id="list">
		{{/* Process the leaderboard list */}}
		{{ range $key, $value := $scratch.Get "leaderboard" }}

			{{/* Split the space delimited value */}}
			{{ $call := replaceRE ".* " "" $value }}
			{{ $count := replaceRE " .*" "" $value }}

			{{/* Add a line to the page list with proper handling for a
			     single net. */}}
			<dt class="twocol" style="width:10em;">{{ $call }}</dt>
			<dd class="twocol"><a href="{{ lower $call }}">{{ $count }} net{{ if ne "1" $count }}s{{ end }}</a></dd>
		{{ end }}
		</dl>
		<p>Updated: {{ now.Format ( $timestamp ) }}</p>
	</div>
{{ end }}
